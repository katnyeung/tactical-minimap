<!doctype html>
<html lang="en">
<head>
<title>Simple Map</title>
<meta name="viewport" content="initial-scale=1.0">
<meta charset="utf-8">
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.3.0/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<style>
#map {
	width: 100%;
	height: 100vh
}
</style>
</head>
<body>
	asdsads
	<div id="map"></div>

	<script>
		var allMarkerList = [];

		$(document).ready(function() {

			var osmUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', osmAttrib = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors', osm = L.tileLayer(osmUrl, {
				maxZoom : 19,
				attribution : osmAttrib
			});

			map = L.map('map').setView([ 22.2757, 114.1648 ], 17).addLayer(osm);

			var popup = L.popup();

			function onMapClick(e) {
				$('#mouseLat').val(e.latlng.lat);
				$('#mouseLng').val(e.latlng.lng);

				popup.setLatLng(e.latlng).setContent($('#coord')[0]).openOn(map);
			}

			map.on('contextmenu', onMapClick);
			map.on('dragend', function(e) {
				console.log(map.getCenter());
				updateMarkers(map.getCenter().lat, map.getCenter().lng);
			});

			updateMarkers(map.getCenter().lat, map.getCenter().lng);

			$("#btnInfoMarker").click(function(e) {
				e.preventDefault();
				var lat = $('#mouseLat').val();
				var lng = $('#mouseLng').val();
				var message = $('#markerMessage').val();

				$.ajax({
					type : "POST",
					url : '/marker/add',
					data : {
						'lat' : lat,
						'lng' : lng,
						'type' : 'info',
						'message' : message
					},
					success : function(data) {
						updateMarkers(map.getCenter().lat, map.getCenter().lng);
					}
				});
			});

			$("#btnWarningMarker").click(function(e) {
				console.log(e);
				e.preventDefault();
				var lat = $('#mouseLat').val();
				var lng = $('#mouseLng').val();
				var message = $('markerMessage').val();

				$.ajax({
					type : "POST",
					url : '/marker/add',
					data : {
						'lat' : lat,
						'lng' : lng,
						'type' : 'warning',
					},
					success : function(data) {
						updateMarkers(map.getCenter().lat, map.getCenter().lng);
					}
				});
			});

			function updateMarkers(lat, lng) {

				allMarkerList.forEach(function(item) {
					map.removeLayer(item);
				});

				$.ajax({
					type : "GET",
					url : '/marker/list',
					data : {
						'lat' : lat,
						'lng' : lng
					},
					success : function(data) {

						data.markerList.forEach(function(item) {
							var marker = L.marker([ item.lat, item.lng ]).addTo(map).bindPopup(item.lat + " : " + item.lng + " , " + item.message);
							allMarkerList.push(marker);
						});

					}
				});
			}
		});
	</script>
	<div id="coord">
		<input type="text" name="lat" id="mouseLat" /> <input type="text" name="lng" id="mouseLng" />
		<table cellpadding="0" cellspacing="0">
			<tr>
				<td><button id="btnDangerMarker" href="#">Danger</button></td>
			</tr>
			<tr>
				<td><button id="btnWarningMarker" href="#">Warning</button></td>
			</tr>
			<tr>
				<td>
					<button id="btnInfoMarker" href="#">Info</button> <textarea id="markerMessage"></textarea>
				</td>
			</tr>

		</table>
	</div>
</body>
</html>