<!doctype html>
<html lang="en">
<head>
<title>Simple Map</title>
<meta name="viewport" content="initial-scale=1.0">
<meta charset="utf-8">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin="" />
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
<style>
.iconMarkup {
	margin-left: -50px !improtant ;
	margin-top: -10px !important;
}
</style>
<style>
#map {
	width: 100%;
	height: 100vh
}
</style>
</head>
<body>
	<div id="map"></div>

	<script>
		var allMarkerList = [];

		$(document).ready(function() {

			var osmUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', osmAttrib = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors. Icons made by <a href="https://www.flaticon.com/authors/those-icons" title="Those Icons">Those Icons</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a>', osm = L.tileLayer(osmUrl, {
				maxZoom : 19,
				attribution : osmAttrib
			});

			map = L.map('map').setView([ 22.2757, 114.1648 ], 17).addLayer(osm);

			var menu = L.popup();

			function onMapClick(e) {
				$('#coord').show();
				menu.setLatLng(e.latlng).setContent($('#coord')[0]).openOn(map);
			}

			map.on('contextmenu', onMapClick);

			map.on('dragend', function(e) {
				updateMarkers(map.getCenter().lat, map.getCenter().lng);
			});

			$("#btnInfoMarker").click(function(e) {
				e.preventDefault();
				var message = $('#markerMessage').val();

				$.ajax({
					type : "POST",
					url : '/marker/add',
					data : {
						'lat' : menu.getLatLng().lat,
						'lng' : menu.getLatLng().lng,
						'type' : 'info',
						'message' : message
					},
					success : function(data) {
						updateMarkers(map.getCenter().lat, map.getCenter().lng);
					}
				});
			});

			$("#btnWarningMarker").click(function(e) {
				e.preventDefault();
				var message = $('#markerMessage').val();

				$.ajax({
					type : "POST",
					url : '/marker/add',
					data : {
						'lat' : menu.getLatLng().lat,
						'lng' : menu.getLatLng().lng,
						'type' : 'warning',
						'message' : message
					},
					success : function(data) {
						updateMarkers(map.getCenter().lat, map.getCenter().lng);
					}
				});
			});

			$("#btnDangerMarker").click(function(e) {
				e.preventDefault();
				var message = $('#markerMessage').val();

				$.ajax({
					type : "POST",
					url : '/marker/add',
					data : {
						'lat' : menu.getLatLng().lat,
						'lng' : menu.getLatLng().lng,
						'type' : 'danger',
						'message' : message
					},
					success : function(data) {
						updateMarkers(map.getCenter().lat, map.getCenter().lng);
					}
				});
			});
			
			$("#btnMedicalMarker").click(function(e) {
				e.preventDefault();
				var message = $('#markerMessage').val();

				$.ajax({
					type : "POST",
					url : '/marker/add',
					data : {
						'lat' : menu.getLatLng().lat,
						'lng' : menu.getLatLng().lng,
						'type' : 'medical',
						'message' : message
					},
					success : function(data) {
						updateMarkers(map.getCenter().lat, map.getCenter().lng);
					}
				});
			});
			
			function updateMarkers(lat, lng) {

				allMarkerList.forEach(function(item) {
					map.removeLayer(item);
				});

				$.ajax({
					type : "GET",
					url : '/marker/list',
					data : {
						'lat' : lat,
						'lng' : lng
					},
					success : function(data) {

						data.markerList.forEach(function(item) {
							var marker;
							var content = 'loading';
							
							if (item.markerCache != null) {
								content = '<a href="#" data-id="'+item.markerId+'" class="btnUp"><i class="fas fa-arrow-up fa-2x"></i>' + item.markerCache.upVote + '</a> <a href="#" data-id="'+item.markerId+'" class="btnDown"><i class="fas fa-arrow-down fa-2x"></i>' + item.markerCache.downVote + '</a> <mark style="font-size:20px">' + item.markerCache.expire + '</mark> <br/>';
							}
							if ( item.controllable ){
								content += item.message == null ? '' : '<h4 style="font-size:16px" class="editableMessage font-weight-normal" data-message="' + item.message + '" data-id="'+ item.markerId +'">' + item.message + '</h4>';
								content += '<a href="#" data-id="'+item.markerId+'" class="btnDelete"><i class="fas fa-trash-alt fa-1x"></i></a>'; 
							}else{
								content += item.message == null ? '' : '<h4 style="font-size:16px" class="font-weight-normal">' + item.message + '</h4>';
							}
							
							var markerIcon = L.icon({
							    iconUrl: '/icon/' + item.icon,

							    iconSize:     [38, 38], // size of the icon
							    popupAnchor:  [0, -14] // point from which the popup should open relative to the iconAnchor
							});

							var popup = L.popup({
								closeOnClick : false,
								autoClose : false,
								autoPan : false,
							    closeButon: false
							}).setContent(content);

							if (item.controllable) {
								marker = L.marker([ item.lat, item.lng ], {
									draggable : item.controllable,
									icon : markerIcon
								}).addTo(map).bindPopup(popup).openPopup();

								marker.on('dragend', function(e) {
									$.ajax({
										type : "POST",
										url : '/marker/move',
										data : {
											'lat' : e.target.getLatLng().lat,
											'lng' : e.target.getLatLng().lng,
											'markerId' : item.markerId
										},
										success : function(data) {
											updateMarkers(map.getCenter().lat, map.getCenter().lng);
										}
									});
								});
								
								marker.on('click', function(e) {
									updateMarkers(map.getCenter().lat, map.getCenter().lng);
								});
							} else {
								marker = L.marker([ item.lat, item.lng ], {
									draggable : item.controllable,
									icon : markerIcon
								}).addTo(map).bindPopup(popup).openPopup();
							}

							allMarkerList.push(marker);

						});
						$(".editableMessage").on("dblclick",function(e){
							$(this).replaceWith('<input type="text" value="' + $(this).data("message") + '" class="messageEditor form-control" data-id="' + $(this).data("id") + '"/>');
							$('.messageEditor').on('keypress',function(e){
							    if(e.which == 13) {
									$.ajax({
										type : "POST",
										url : '/marker/updateMessage',
										data : {
											'message' : $(this).val(),
											'markerId' : $(this).data("id")
										},
										success : function(data) {
											updateMarkers(map.getCenter().lat, map.getCenter().lng);
										}
									});
							    }
							});	
						});
						
		
						$(".btnDelete").on("click", function(e) {
							e.preventDefault();
							console.log($(this).data("id"));

							$.ajax({
								type : "POST",
								url : '/marker/delete',
								data : {
									'markerId' : $(this).data("id")
								},
								success : function(data) {
									updateMarkers(map.getCenter().lat, map.getCenter().lng);
								}
							});
						});
						
						$(".btnUp").on("click", function(e) {
							e.preventDefault();
							console.log($(this).data("id"));

							$.ajax({
								type : "POST",
								url : '/marker/up',
								data : {
									'markerId' : $(this).data("id")
								},
								success : function(data) {
									updateMarkers(map.getCenter().lat, map.getCenter().lng);
								}
							});
						});

						$(".btnDown").on("click", function(e) {
							e.preventDefault();
							console.log($(this).data("id"));

							$.ajax({
								type : "POST",
								url : '/marker/down',
								data : {
									'markerId' : $(this).data("id")
								},
								success : function(data) {
									updateMarkers(map.getCenter().lat, map.getCenter().lng);
								}
							});
						});
					}
				});

			}

			window.setInterval(intervalUpdate(), 1000);
			function intervalUpdate() {
				updateMarkers(map.getCenter().lat, map.getCenter().lng);
			}
		});
	</script>

	<div id="coord" style="width: 300px;display:none">
		<div>
			<button id="btnDangerMarker" class="btn btn-danger mt-1" style="width: 100%">Danger</button>
		</div>
		<div>
			<button id="btnWarningMarker" class="btn btn-warning mt-1" style="width: 100%">Warning</button>
		</div>
		<div>
			<button id="btnInfoMarker" class="btn btn-info mt-1" style="width: 100%">Info</button>
		</div>		
		<div>
			<button id="btnMedicalMarker" class="btn mt-1" style="width: 100%">Medical</button>
		</div>
		<div>
			<textarea id="markerMessage" class="form-control mt-1" rows="2" placeholder="(Message)"></textarea>
		</div>
	</div>
</body>
</html>