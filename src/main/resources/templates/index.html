<!doctype html>
<html lang="en">
<head>
<title>蓮圖 limap.co</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
<meta name="description" content="感謝大大無私分享 樓主好人一生平安">  
<meta name="keywords" content="Distributed Marker Application for Hong Kong Area">
<meta name="robots" content="noindex, nofollow" />
<meta charset="utf-8">

<link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">

<script src="/js/jquery-3.4.1.min.js"></script>

<link rel="stylesheet" href="/css/leaflet.css" />
<link rel="stylesheet" href="/css/bootstrap.min.css" />
<link rel="stylesheet" href="/css/leaflet-search.css" />
<link rel="stylesheet" href="/css/leaflet.draw.css" />
<link rel="stylesheet" href="/css/fontawesome-5.8.1.all.css" />

<script src="/js/leaflet.js"></script>
<script src="/js/leaflet-search.js"></script>
<script src="/js/leaflet.draw.js"></script>
<script src="/js/leaflet.draw.polyline.js"></script>

<script async defer src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.2"></script>
<script src="/js/twitch.tv.v1.js"></script>
<script src="/js/paste.js"></script>

<style>
.iconMarkup {
	margin-left: -50px!improtant;
	margin-top: -10px !important;
}

.livestream-icon {
	width: 600px !important;
	margin-left: -150px !important;
	margin-top: -300px !important;
}

.btn-sm {
	margin: 0 !important;
	padding: 0 !important;
	font-size: 10px;
	opacity: 0.6;
}

#map {
	width: 100%;
	height: 100vh;
}

.location-icon {
	width: 200px;
}

html * {
	font-family: Trebuchet MS;
}

.pulse {
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
      -moz-box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.4);
      box-shadow: 0 0 0 0;
    }
    70% {
        -moz-box-shadow: 0 0 0 35px rgba(0, 0, 0, 0);
        box-shadow: 0 0 0 35px rgba(0, 0, 0, 0);
    }
    100% {
        -moz-box-shadow: 0 0 0 0 rgba(0, 0, 0, 0);
        box-shadow: 0 0 0 0 rgba(0, 0, 0, 0);
    }
}
 
</style>
</head>
<body>
	<div id="map"></div>
	
	<script th:inline="javascript">
		var loggedLayers = [[${loggedLayers}]];
		var layerKeys = [[${layerKeys}]];
		var layerKeysString = [[${layerKeysString}]];
		var layerMap = [[${layerMap}]];
		var colorMap = {'red':'#F5B7B1','blue':'#7FB3D5','green':'#D0ECE7','orange':'#F9E79F','purple':'#E8DAEF'};
		var validLayers = [[${validLayers}]];
		
		var key = [[${key}]];
		
		var allMarkerList = [];
		var pause = false;
		
		var dragLock = true;
		var maxZIndex = 1;
		
		L.Marker.prototype.__setPos = L.Marker.prototype._setPos;
		L.Marker.prototype._setPos = function ()
		{
		    L.Marker.prototype.__setPos.apply(this, arguments);
		    this._zIndex = this.options.zIndexOffset;
		    this._resetZIndex();
		};
		
		String.prototype.toMMSS = function () {
		    var sec_num = parseInt(this, 10); 
		    var hours   = Math.floor(sec_num / 3600);
		    var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
		    var seconds = sec_num - (hours * 3600) - (minutes * 60);

		    if (hours   < 10) {hours   = "0"+hours;}
		    if (minutes < 10) {minutes = "0"+minutes;}
		    if (seconds < 10) {seconds = "0"+seconds;}
		    
		    if(Math.floor(sec_num / 3600) > 0){
			    return hours+':'+minutes+':'+seconds;
		    }else{
			    return minutes+':'+seconds;
		    }
		}
		
		String.prototype.formatDate = function () {
		    var date = new Date(Date.parse(this));
		    
		    var hours   = date.getHours();
		    var minutes = date.getMinutes();
		    
		    if (hours   < 10) {hours   = "0"+hours;}
		    if (minutes < 10) {minutes = "0"+minutes;}
		    
		    return hours + ":" + minutes;
		}
		
		Number.prototype.toFixedDown = function(digits) {
		    var re = new RegExp("(\\d+\\.\\d{" + digits + "})(\\d)");
		    var m = this.toString().match(re);
		    
		    return m ? parseFloat(m[1]) : this.valueOf();
		};
		
		jQuery.fn.center = function () {
		    this.css("position","absolute");
		    this.css("top", Math.max(0, (($(window).height() - $(this).outerHeight()) / 2) + $(window).scrollTop()) + "px");
		    this.css("left", Math.max(0, (($(window).width() - $(this).outerWidth()) / 2) + $(window).scrollLeft()) + "px");
		    this.css("z-index" , 999);
		    return this;
		}
		
		function showRegister(layer) {
			$('#registerLayerKey').val(layer);
			$('#registerFormDiv').center();
			$('#registerFormDiv').show();
		}

		$(document).ready(function() {
			
			$('#registerFormDiv').hide();
			$('#registerForm').submit(function(e){
				e.preventDefault();
				
				$.ajax({
					type : "POST",
					url : '/register',
					data : $(this).serialize(),
					
					success : function(data) {
						if(data.status == "success"){
							window.location.reload();
						}else{
							alert(data.remarks);
						}
					}
				});
			});
			
			var osmUrl = '/m/{z}/{x}/{y}.png', 
				osmAttrib = '&copy; 地圖版權屬香港特區政府 <a href="http://www.map.gov.hk">www.map.gov.hk</a> Icons made by <a href="https://www.flaticon.com/authors/those-icons" title="Those Icons">Those Icons</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a>', 
				osm = L.tileLayer(osmUrl, {	maxZoom : 20,attribution : osmAttrib});

			map = L.map('map').setView([ [[${lat}]], [[${lng}]] ], [[${zoom}]]).addLayer(osm);

			map.addControl( new L.Control.Search({
				url: 'https://nominatim.openstreetmap.org/search?format=json&q={s}',
				jsonpParam: 'json_callback',
				propertyName: 'display_name',
				propertyLoc: ['lat','lon'],
				marker: L.circleMarker([0,0],{radius:20}),
				autoCollapse: true,
				autoType: false,
				minLength: 2
			}));


			var command = L.control({position: 'bottomleft'});
			
			command.onAdd = function (map) {
			    
			    var htmlContent = "<div class='container mb-5 ml-n3 mr-4'>";
			    
			    if(loggedLayers.length > 0){
			    	htmlContent += '<div class="row ml-1"><select name="layer" id="markerLayer" class="btn-warning rounded" style="padding:5px">';
			    	
			    	loggedLayers.forEach(function(loggedItem){
						if(layerKeys.includes(loggedItem)){
			    			htmlContent += '<option value="' + loggedItem + '">' + loggedItem + "</option>";
						}
			    	});
			    	
			    	htmlContent += '</select></div>'; 
				}
			    
				layerKeys.forEach(function (item) {
					htmlContent += '<div class="row ml-1">';
					
					if(!loggedLayers.includes(item)){
						if(validLayers.includes(item)){
							htmlContent += '<form class="layerLoginForm row"><div class="col-5"><input type="hidden" name="layerKey" value="'+item+'"/><input type="password" name="password" placeholder="('+item+' password)" style="width:100px"/></div><div class="col-1"><button type="submit">Login</button></div></form>'; 
						}else{
							htmlContent += '<div class="row ml-1"><button onclick="showRegister(\''+ item+'\')">register '+item+'</button></div>'; 
						}
					}
					htmlContent += '</div>';
				});

			    htmlContent += "</div>";

			    var div = L.DomUtil.create('div', 'command');
			    div.innerHTML = htmlContent;
			    
			    return div;

			}

			command.addTo(map);

			var helpControl =  L.Control.extend({
			
				options: {
					position: 'bottomright'
				},
				
				onAdd: function (map) {
					var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
					container.id = 'helpControl';
					container.innerHTML = '<i class="far fa-flag fa-2x"></i>';
					container.style = 'background-color:white;padding:3px;font-size:8px;color:#666666';
					
					container.onclick = function(){
						window.open('https://docs.google.com/document/d/1_fB1PXTwfpnjwhP0xS0grxl6KoYcQHAC1cTOvFN0DGM/edit?usp=sharing','info_document');
					}
					
					return container;
				}
			});
		    
		    map.addControl(new helpControl());
		    
			if(loggedLayers.length > 0){
				
				drawnItems = L.featureGroup().addTo(map);
				
				map.addControl(new L.Control.Draw({
					draw: {
						polygon: true,
						polyline: true,
						circlemarker: false,
						circle:false,
						rectangle: true,
						marker: false,
					},
					edit: {
						featureGroup: drawnItems,
						remove: false,
						edit:false
					}
				}));


			    map.on(L.Draw.Event.CREATED, function (e) {
					var type = e.layerType;
					var layerObject = e.layer;
					
					var latlngArr = [];
					
					if(Array.isArray(layerObject.getLatLngs()[0])){
						latlngArr = layerObject.getLatLngs()[0];
					}else{
						latlngArr = layerObject.getLatLngs();
					}
					
					var layer = $('#markerLayer').val();
					
					if(layer){
						$.ajax({
							type : "POST",
							url : '/marker/add',
							data : {
								'lat' : latlngArr[latlngArr.length-1].lat,
								'lng' : latlngArr[latlngArr.length-1].lng,
								'shapeType' : type,
								'type' : 'shape',
								'layer' : layer,
								'message' : '',
								'shapeList' : JSON.stringify(latlngArr)
							},
							success : function(data) {
								if(data.status == 'success'){
									updateMarkers(map.getCenter().lat, map.getCenter().lng);
								}else{
									if(data.status == 'success'){
										updateMarkers(map.getCenter().lat, map.getCenter().lng);
									}else{
										var alertPopup = L.popup();
										alertPopup.setLatLng(map.getCenter()).setContent(data.remarks).openOn(map);
									}
								}
							}
						});
					}else{
						var alertPopup = L.popup();
						alertPopup.setLatLng(map.getCenter()).setContent('no logged layer').openOn(map);
					}
			    });

				var fullScreenControl =  L.Control.extend({
				
					options: {
						position: 'topright'
					},
					
					onAdd: function (map) {
						var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
						container.id = 'fullScreenControl';
						container.innerHTML = '<i class="fas fa-expand fa-2x"></i>';
						container.style = 'background-color:white;padding:3px;font-size:8px;color:#666666';
						
						container.onclick = function(){
							toggleFullScreen();
						}
						
						return container;
					}
				});
			    
			    map.addControl(new fullScreenControl());
			    
				var dragLockControl =  L.Control.extend({
				
					options: {
						position: 'topright'
					},
					
					onAdd: function (map) {
						var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
						container.id = 'dragLockButton';
						container.innerHTML = '<i class="fas fa-lock fa-2x"></i>';
						container.style = 'background-color:white;padding:3px;font-size:8px;color:#666666';
						
						container.onclick = function(){
							if(dragLock){
								dragLock = false;
								$('#dragLockButton')[0].innerHTML = '<i class="fas fa-unlock fa-2x"></i>';
							}else{
								dragLock = true;
								$('#dragLockButton')[0].innerHTML = '<i class="fas fa-lock fa-2x"></i>';
							}
							
							updateMarkers(map.getCenter().lat, map.getCenter().lng);
						}
						
						return container;
					}
				});
			    
			    map.addControl(new dragLockControl());
			}

		    $('.layerLoginForm').submit(function(e){
		    	e.preventDefault();
				$.ajax({
					type : "GET",
					url : '/login',
					data : $(this).serialize(),
					
					success : function(data){
						if(data.status == 'success'){
							window.location.reload(false); 
						}else{
							var alertPopup = L.popup();
							alertPopup.setLatLng(map.getCenter()).setContent(data.remarks).openOn(map);
						}
					}
				});
		    })
			
			var menu = L.popup();
			var menuLatLng;
			
			function onMapClick(e) {
				 menuLatLng = e.latlng;
				$('#coord').show();
				menu.setLatLng(e.latlng).setContent($('#coord')[0]).openOn(map);
			}

			map.on('contextmenu', onMapClick);

			map.on('dragend zoomend', function(e) {
				history.replaceState(null, null, '/l/' + layerKeysString + '/' + map.getZoom() + "/" + map.getCenter().lat.toFixedDown(4) + "/" + map.getCenter().lng.toFixedDown(4));
			});

			
			updateMarkers(map.getCenter().lat, map.getCenter().lng);
			
			clickRegister($("#btnInfoMarker"), 'info');
			clickRegister($("#btnRedInfoMarker"), 'redinfo');
			clickRegister($("#btnYellowInfoMarker"), 'yellowinfo');
			
			clickRegister($("#btnMedicalMarker"), 'medical');
			clickRegister($("#btnGroupMarker"), 'group');
			clickRegister($("#btnSupplyMarker"), 'supply');

			clickRegister($("#btnBlockadeMarker"), 'blockade');
			clickRegister($("#btnWarningMarker"), 'warning');
			clickRegister($("#btnPoliceMarker"), 'police');

			clickRegister($("#btnFBLiveStreamMarker"), 'fb_livestream');
			clickRegister($("#btnTwitchLiveStreamMarker"), 'twitch_livestream');
			
			function clickRegister(button,type){
				button.click(function(e) {
					e.preventDefault();
					var message = $('#markerMessage').val();
					var layer = $('#markerLayer').val();
					
					if(layer){
						$.ajax({
							type : "POST",
							url : '/marker/add',
							data : {
								'lat' : menu.getLatLng().lat,
								'lng' : menu.getLatLng().lng,
								'type' : type,
								'layer' : layer,
								'message' : message
							},
							success : function(data) {
								if(data.status == 'success'){
									$('#markerMessage').val('');
									map.closePopup();
									updateMarkers(map.getCenter().lat, map.getCenter().lng);
								}else{
									var alertPopup = L.popup();
									alertPopup.setLatLng(menuLatLng).setContent(data.remarks).openOn(map);
								}
							}
						});
					}else{
						alertPopup.setLatLng(map.getCenter()).setContent('layer not logged').openOn(map);
					}
				
				});
			}
			
			if(typeof(EventSource) !== "undefined") {
			    var eventSource = new EventSource("/markerEvents?key="+ key +"&layerKeys=" + layerKeysString + "&lat=" + map.getCenter().lat  + "&lng=" + map.getCenter().lng);
			    
				eventSource.onmessage = e => {
					if(!pause){
						var markerList = JSON.parse(e.data);
						processMarker(markerList);
					}
				};
			} 
			
			function updateMarkers(lat, lng) {
				if(!pause){
					$.ajax({
						type : "GET",
						url : '/marker/' + layerKeysString + '/list',
						data : {
							'lat' : lat,
							'lng' : lng
						},
						
						success : function(data){ processMarker(data.markerList)}
					});
				}
			}
			
			function processMarker(markerList){
				allMarkerList.forEach(function(item, index, object){
					var marker = $.grep(markerList, function(e){ return e.markerId == item.markerId; });
					if(marker.length == 0){
						if(item.relatedMarker){
							map.removeLayer(item.relatedMarker);
						}
						if(item.relatedShape){
							map.removeLayer(item.relatedShape);
						}
						map.removeLayer(item);
						object.splice(index, 1);
					}
				});
				
				markerList.forEach(function(item) {
					var marker = $.grep(allMarkerList, function(e){ return e.markerId == item.markerId; });
					
					var upDownButton = 'loading';
					var counter = '**';
					var textMessage = '<mark class="rounded message" style="white-space: pre; background-color:' + colorMap[layerMap[item.layer.layerKey]] + '">' + (item.message == '' ? item.layer.layerKey : '' + item.layer.layerKey + ':' + item.message) +  '</mark><br/>';
					var message = '';
					var deleteBtn = '';
					var content = 'loading';
					var pulseClass;
					var pulseStyle;
					var copyButton = '';
					
					if (item.controllable){						
						message = '<span style="font-size:20px;width:100%" class="editableMessage" data-message="' + item.message + '" data-id="'+ item.markerId +'">' + (item.message == '' ? '<span style="color:#CCCCCC">(Message)</span>' : item.message) + '</span>';
						deleteBtn = ' <a href="#" data-id="'+item.markerId+'" class="btn m-0 p-0 btnDelete"><i class="fas fa-trash-alt fa-1x"></i></a>'; 
					}else{
						message = '<span style="font-size:20px;width:100%" class="font-weight-normal">' + item.message + '</span>';
					}
					
					if(loggedLayers.length > 0){
				    	loggedLayers.forEach(function(loggedItem){
				    		if(loggedItem != 'public'){
								if(layerKeys.includes(loggedItem)){
									if(item.layer.layerKey != loggedItem){
										copyButton += '<a href="#" data-id="' + item.markerId + '" data-layer="'+loggedItem+'" class="btnCopy mark">&gt;'+loggedItem+'</a>';
									}
								}	
				    		}
				    	});
				    	
					}
					
					if (item.markerCache != null) {
						upDownButton = '<div style="width:120px;font-size:16px"><mark class="rounded p-1"><a href="#" data-id="'+item.markerId+'" class="m-0 p-0 btnUp"><i class="far fa-thumbs-up"></i>' + item.markerCache.upVote + '</a>&nbsp;<a href="#" data-id="'+item.markerId+'" class="text-secondary m-0 p-0 btnDown"><i class="far fa-thumbs-down"></i>' + item.markerCache.downVote + '</a>' + deleteBtn + '</mark></div>';
						
						var stopWatchClass = '';
						if(item.markerCache.expire < 30){
							stopWatchClass = 'text-danger';
						}
						
						counter = '<div style="width:150px"><mark class="rounded" style="font-size:14px;background-color:' + colorMap[layerMap[item.layer.layerKey]] + '"><i class="far fa-clock pr-1" style="width: 11%"></i>' + ("" + item.lastupdatedate).formatDate() + '</mark><mark style="font-size:12px;background-color:' + colorMap[layerMap[item.layer.layerKey]] + '" class="rounded m-0 ' + stopWatchClass +'"><i class="fas fa-stopwatch pr-1" style="width: 8%"></i>' + ("" + item.markerCache.expire).toMMSS() + '</mark></div>';
						
						if(item.markerCache.pulse > 0){
							pulseStyle = 'background: red;  color: #E74C3C; padding:1px';
							pulseClass = 'pulse';
						}
					}

					content = message;
					
					var popup = L.popup().setContent(content);
					
					var htmlContent;

					if(item.type == 'livestream'){
						htmlContent = '<div><img src="/icon/'+item.icon+'" class="m-n4" style="width:' + item.iconSize + 'px; height:' + item.iconSize + 'px"/><div><mark class="rounded message" style="white-space: nowrap;">' + item.layer.layerKey + '</mark>' + counter + upDownButton + '</div></div>'
					}else{
						htmlContent = '<div><img src="/icon/'+item.icon+'" class="m-n4 '+ pulseClass +'" style="width:' + item.iconSize + 'px; height:' + item.iconSize + 'px; '+ pulseStyle +'" /><div>' + textMessage + counter + upDownButton + copyButton + '</div></div>'
					}
					
					divIcon = L.divIcon({
						className:'location-icon',
						html: htmlContent,
						popupAnchor:  [-3, -14],
						iconAnchor: [-5, 10], 
					});
					
					var imageContent;
					
					if(item.controllable){
						imageContent = '<img src="/images/i/'+item.imagePath+'"/><span style="font-size:20px;width:100%" class="editableMessage" data-message="'+item.message+'" data-id="'+ item.markerId +'">'+ (item.message ? item.message : '<span style="color:#CCCCCC">(Message)</span>') +'</span>'
					}else{
						imageContent = '<img src="/images/i/'+item.imagePath+'"/><span style="font-size:20px;width:100%" data-message="'+item.message+'" data-id="'+ item.markerId +'">'+item.message+'</span>'
					}
					
					var imagePopup = L.popup().setContent(imageContent);
					
					if(marker.length == 0){
						
						marker = L.marker([ item.lat, item.lng ], {
							draggable : !dragLock && item.controllable,
							icon : divIcon
						}).addTo(map)
						
						marker.setZIndexOffset(0);		
						
						if(item.type == 'image'){

							marker.bindPopup(imagePopup, {
								autoPan: false,
								keepInView: false,
								autoClose: true,
								maxWidth: "auto"
							});
						}else{
							marker.bindPopup(popup, {
								autoPan: false,
								keepInView: false,
								autoClose: true,
							});
						}
						
						
						if(item.type == 'shape'){
							
							var shape;
							
							if(item.shapeType =='polyline'){
								shape = L.polyline([],{color: '#FF6000', weight: 4});
								
								item.shapeList.forEach(function(shapePoint) {
									shape.addLatLng(shapePoint);
								});
							} else if(item.shapeType =='polygon' || item.shapeType =='rectangle'){
								shape = L.polygon([],{weight: 3});
								
								item.shapeList.forEach(function(shapePoint) {
									shape.addLatLng(shapePoint);
								});
							} 
							shape.addTo(map);
							
							marker.relatedShape = shape;
						}
						
						if(item.type == 'twitch_livestream'){
							
							var twitchStream = '<div class="row" id="twitch_live_frame_'+item.markerId+'"><div id="twitch_live_' + item.markerId + '" class="col-12"></div>'+
							'<div class="col-12" style="width:200px"><button class="btn btn-light btn-sm" id="twitch_live_button_' + item.markerId + '">Hide</button><button class="btn btn-light btn-sm" id="twitch_live_button_small_' + item.markerId + '">Small</button><button class="btn btn-primary btn-sm" id="twitch_live_button_big_' + item.markerId + '">Large</button><button class="btn btn-primary btn-sm" id="twitch_live_button_biggest_' + item.markerId + '">Biggest</button></div></div>';
							
							var twitchStreamIcon = L.divIcon({
							    className:'livestream-icon',
							    html: twitchStream
							});
							
							var twitchMarker = L.marker([ item.lat, item.lng ], {
								icon : twitchStreamIcon,
								autoPan: false,
							}).addTo(map);
							
							marker.relatedMarker = twitchMarker;
							
							new Twitch.Embed('twitch_live_' + item.markerId + '', {
								width:'100%',
								height:'100%',
								layout:'video',
								channel: item.message
							});
							
							$('#twitch_live_button_' + item.markerId).click(function(){
								$('#twitch_live_' + item.markerId).hide();
								$('#twitch_live_button_' + item.markerId).hide();
								$('#twitch_live_frame_' + item.markerId).css({ 'margin-left': '25px' });
								$('#twitch_live_frame_' + item.markerId).css({ 'margin-top': '280px' });
							});
							
							$('#twitch_live_button_small_' + item.markerId).click(function(){
								$('#twitch_live_' + item.markerId).show();
								$('#twitch_live_frame_' + item.markerId).width(300);
								$('#twitch_live_frame_' + item.markerId).height(70);
								
								$('#twitch_live_frame_' + item.markerId).css({ 'margin-left': '0' });
								$('#twitch_live_frame_' + item.markerId).css({ 'margin-top': '125px' });
								$('#twitch_live_button_' + item.markerId).show();
							});
							
							$('#twitch_live_button_big_' + item.markerId).click(function(){
								$('#twitch_live_' + item.markerId).show();
								$('#twitch_live_frame_' + item.markerId).width(400);
								$('#twitch_live_frame_' + item.markerId).height(300);
								$('#twitch_live_frame_' + item.markerId).css({ 'margin-left': '0' });
								$('#twitch_live_frame_' + item.markerId).css({ 'margin-top': '65px' });
								$('#twitch_live_button_' + item.markerId).show();
							});							
							
							$('#twitch_live_button_biggest_' + item.markerId).click(function(){
								$('#twitch_live_' + item.markerId).show();
								$('#twitch_live_frame_' + item.markerId).width(600);
								$('#twitch_live_frame_' + item.markerId).height(450);
								$('#twitch_live_frame_' + item.markerId).css({ 'margin-left': '0' });
								$('#twitch_live_frame_' + item.markerId).css({ 'margin-top': '-10px' });
								$('#twitch_live_button_' + item.markerId).show();
							});
							
							$('#twitch_live_' + item.markerId).hide();
							$('#twitch_live_button_' + item.markerId).hide();
							$('#twitch_live_frame_' + item.markerId).css({ 'margin-left': '25px' });
							$('#twitch_live_frame_' + item.markerId).css({ 'margin-top': '280px' });
							
						}

						if(item.type == 'fb_livestream'){
							  
							var fbStream = '<div class="row" id="fb_live_frame_' + item.markerId + '"><div id="fb_live_' + item.markerId + '" class="fb-video col-12" data-href="' + item.message + '" data-width="500"  data-show-text="false"><div class="fb-xfbml-parse-ignore"><blockquote cite="' + item.message + '"></blockquote></div></div>' + 
							'<div class="col-12" style="width:200px"><button class="btn btn-light btn-sm" id="fb_live_button_' + item.markerId + '">Hide</button><button class="btn btn-light btn-sm" id="fb_live_button_small_' + item.markerId + '">Small</button><button class="btn btn-primary btn-sm" id="fb_live_button_big_' + item.markerId + '">Large</button><button class="btn btn-primary btn-sm" id="fb_live_button_biggest_' + item.markerId + '">Biggest</button></div></div>';
							
							var fbStreamIcon = L.divIcon({
							    className:'livestream-icon',
							    html: fbStream
							});
							
							var fbMarker = L.marker([ item.lat, item.lng ], {
								icon : fbStreamIcon,
								autoPan: false,
							}).addTo(map);
							
							marker.relatedMarker = fbMarker;

							FB.XFBML.parse(null);
							
							$('#fb_live_button_' + item.markerId).click(function(){
								$('#fb_live_' + item.markerId).hide();
								$('#fb_live_button_' + item.markerId).hide();
								$('#fb_live_frame_' + item.markerId).css({ 'margin-left': '25px' });
								$('#fb_live_frame_' + item.markerId).css({ 'margin-top': '280px' });
							});
							
							$('#fb_live_button_small_' + item.markerId).click(function(){
								$('#fb_live_' + item.markerId).show();
								$('#fb_live_frame_' + item.markerId).width(200);
								$('#fb_live_frame_' + item.markerId).css({ 'margin-left': '0' });
								$('#fb_live_frame_' + item.markerId).css({ 'margin-top': '155px' });
								$('#fb_live_button_' + item.markerId).show();
							});
							
							$('#fb_live_button_big_' + item.markerId).click(function(){
								$('#fb_live_' + item.markerId).show();
								$('#fb_live_frame_' + item.markerId).width(400);
								$('#fb_live_frame_' + item.markerId).css({ 'margin-left': '0' });
								$('#fb_live_frame_' + item.markerId).css({ 'margin-top': '75px' });
								$('#fb_live_button_' + item.markerId).show();
							});							
							
							$('#fb_live_button_biggest_' + item.markerId).click(function(){
								$('#fb_live_' + item.markerId).show();
								$('#fb_live_frame_' + item.markerId).width(600);
								$('#fb_live_frame_' + item.markerId).css({ 'margin-left': '0' });
								$('#fb_live_frame_' + item.markerId).css({ 'margin-top': '0px' });
								$('#fb_live_button_' + item.markerId).show();
							});
							
							$('#fb_live_' + item.markerId).hide();
							$('#fb_live_button_' + item.markerId).hide();
							$('#fb_live_frame_' + item.markerId).css({ 'margin-left': '25px' });
							$('#fb_live_frame_' + item.markerId).css({ 'margin-top': '280px' });
						}
						
						marker.on('click', function(e){
							marker.setZIndexOffset(maxZIndex++);		
						});
						
					    marker.on('dragstart', function(e) {
					    	  pause = true;
					    });
					    
						marker.on('dragend', function(e) {
							$.ajax({
								type : "POST",
								url : '/marker/move',
								data : {
									'lat' : e.target.getLatLng().lat,
									'lng' : e.target.getLatLng().lng,
									'markerId' : item.markerId
								},
								success : function(data) {
									pause = false;
									updateMarkers(map.getCenter().lat, map.getCenter().lng);
								}
							});
							
							if(marker.relatedMarker){
								marker.relatedMarker.setLatLng(e.target.getLatLng());
							}
							
						})
												
						marker.on('dblclick', function(event){
							if(item.controllable){
								$.ajax({
									type : "POST",
									url : '/marker/pulse',
									data : {
										'markerId' : item.markerId
									},
									success : function(data) {
										updateMarkers(map.getCenter().lat, map.getCenter().lng);
									}
								});
							}

						});
						
						marker.markerId = item.markerId;
						marker.setOpacity(item.opacity);
						
						allMarkerList.push(marker);
					}else{
						
						marker[0].setIcon(divIcon);
						
						if(item.type == 'image'){
							marker[0].setPopupContent(imageContent);
						}else{
							marker[0].setPopupContent(content);
						}
						
						marker[0].setOpacity(item.opacity);
						
						if(!dragLock && item.controllable){
							marker[0].dragging.enable();
						}else{
							marker[0].dragging.disable();
						}
						
						if(item.lat != marker.lat || item.lng != marker.lng){
							var newLatLng = new L.LatLng(item.lat, item.lng);
							marker[0].setLatLng(newLatLng); 
							
							if(marker[0].relatedMarker){
								marker[0].relatedMarker.setLatLng(newLatLng);
							}							
							
							if(marker[0].relatedShape){
								if(item.shapeList){
									var shape;
									
									if(item.shapeType =='polyline'){
										shape = L.polyline([]);
										
										item.shapeList.forEach(function(shapePoint) {
											shape.addLatLng(shapePoint);
										});
									} else if(item.shapeType =='polygon' || item.shapeType =='rectangle'){
										shape = L.polygon([]);
										
										item.shapeList.forEach(function(shapePoint) {
											shape.addLatLng(shapePoint);
										});
									}
									
									marker[0].relatedShape.setLatLngs(shape.getLatLngs());
								}
							}
						}
					}
					document.querySelector(".leaflet-popup-pane").addEventListener("load", function(event) {
						  var tagName = event.target.tagName,
						  popup = map._popup;
						  
						  // Also check if flag is already set.
						  if (tagName === "IMG" && popup && !popup._updated) {
						    popup._updated = true; // Set flag to prevent looping.
						    popup.update();
						  }
						  
						}, true);
				});
				
				$(".btnDelete").on("click", function(e) {
					var button = $(this);
					e.preventDefault();
					if(confirm("delete?")){
						$.ajax({
							type : "POST",
							url : '/marker/delete',
							data : {
								'markerId' : button.data("id")
							},
							success : function(data) {
								if(data.status == 'success'){
									updateMarkers(map.getCenter().lat, map.getCenter().lng);
								}else{
									var markers = $.grep(allMarkerList, function(e){ return e.markerId == button.data("id") });
									
									var alertPopup = L.popup();
					
									alertPopup.setLatLng(markers[0].getLatLng()).setContent(data.remarks).openOn(map);
								}
							}
						});
					}
				});
				
				$(".btnCopy").on("click", function(e) {
					var button = $(this);
					e.preventDefault();
					if(confirm("Copy to " + button.data("layer") + "?")){
						$.ajax({
							type : "POST",
							url : '/marker/copy',
							data : {
								'layer' : button.data("layer"),
								'markerId' : button.data("id")
							},
							success : function(data) {
							    pause = false;
								updateMarkers(map.getCenter().lat, map.getCenter().lng);
							}
						});
					}
				});
				
				$(".btnUp").on("click", function(e) {
					var button = $(this);
					e.preventDefault();

					$.ajax({
						type : "POST",
						url : '/marker/up',
						data : {
							'markerId' : button.data("id")
						},
						success : function(data) {
							if(data.status == 'success'){
								updateMarkers(map.getCenter().lat, map.getCenter().lng);
							}else{
								var markers = $.grep(allMarkerList, function(e){ return e.markerId == button.data("id") });
								
								var alertPopup = L.popup();
				
								alertPopup.setLatLng(markers[0].getLatLng()).setContent(data.remarks).openOn(map);
							}
						}
					});
				});

				$(".btnDown").on("click", function(e) {
					var button = $(this);
					e.preventDefault();
					
					$.ajax({
						type : "POST",
						url : '/marker/down',
						data : {
							'markerId' : button.data("id")
						},
						success : function(data) {
							if(data.status == 'success'){
								updateMarkers(map.getCenter().lat, map.getCenter().lng);
							}else{
								var markers = $.grep(allMarkerList, function(e){ return e.markerId == button.data("id") });
								
								var alertPopup = L.popup();
				
								alertPopup.setLatLng(markers[0].getLatLng()).setContent(data.remarks).openOn(map);
							}
						}
					});
				});
				
				$(".editableMessage").on("dblclick",function(e){
					pause = true;
					$(this).replaceWith('<input type="text" value="' + $(this).data("message") + '" class="messageEditor form-control" data-id="' + $(this).data("id") + '"/>');
					$('.messageEditor').on('keypress blur',function(e){
					    if(e.which == 13 || e.type == 'blur') {
							$.ajax({
								type : "POST",
								url : '/marker/updateMessage',
								data : {
									'message' : $(this).val(),
									'markerId' : $(this).data("id")
								},
								success : function(data) {
								    pause = false;
									updateMarkers(map.getCenter().lat, map.getCenter().lng);
								}
							});
					    }
					});	
					
				});
				
			}
			$('#btnImageMarker').on('click',function(){
				$('#imageUploadFile').trigger('click');
				
			});
			 $('#imageUploadFile').change(function (e) {
                 
                 var file_data = $('#imageUploadFile').prop('files')[0];
                 var form_data = new FormData();
                 form_data.append('file', file_data);
                 
                 $.ajax({
                     url: '/images/imageUpload', 
                     dataType: 'text', 
                     cache: false,
                     contentType: false,
                     processData: false,
                     data: form_data,
                     type: 'post',
                     success: function (response) {
						res = JSON.parse(response);
                        
    					var message = $('#markerMessage').val();
    					var layer = $('#markerLayer').val();
    					
    					if(layer){
    						$.ajax({
    							type : "POST",
    							url : '/marker/add',
    							data : {
    								'lat' : menu.getLatLng().lat,
    								'lng' : menu.getLatLng().lng,
    								'type' : 'image',
    								'layer' : layer,
    								'message' : message,
    								'imagePath': res.filePath
    							},
    							success : function(data) {
    								if(data.status == 'success'){
    									$('#markerMessage').val('');
    									map.closePopup();
    									updateMarkers(map.getCenter().lat, map.getCenter().lng);
    								}else{
    									var alertPopup = L.popup();
    									alertPopup.setLatLng(menuLatLng).setContent(data.remarks).openOn(map);
    								}
    							}
    						});
    					}else{
							var alertPopup = L.popup();
    						alertPopup.setLatLng(map.getCenter()).setContent('layer not logged').openOn(map);
    					}
                     },
                     error: function (response) {
						var alertPopup = L.popup();
   						alertPopup.setLatLng(map.getCenter()).setContent(response).openOn(map);
                     }
                 });
			});
			
			$('#markerMessage').pastableTextarea();
			
			$('#markerMessage').on('pasteImage', function(ev, data){
				var file_data = data.blob;
				var form_data = new FormData();
				form_data.append('file', file_data);

				$.ajax({
					url: '/images/imageUpload', 
					dataType: 'text', 
					cache: false,
					contentType: false,
					processData: false,
					data: form_data,
					type: 'post',
					success: function (response) {
						res = JSON.parse(response);
                  
						var message = $('#markerMessage').val();
						var layer = $('#markerLayer').val();
			
						if(layer){
							$.ajax({
								type : "POST",
								url : '/marker/add',
								data : {
									'lat' : menu.getLatLng().lat,
									'lng' : menu.getLatLng().lng,
									'type' : 'image',
									'layer' : layer,
									'message' : message,
									'imagePath': res.filePath
								},
								success : function(data) {
									if(data.status == 'success'){
										$('#markerMessage').val('');
										map.closePopup();
										updateMarkers(map.getCenter().lat, map.getCenter().lng);
									}else{
										var alertPopup = L.popup();
										alertPopup.setLatLng(menuLatLng).setContent(data.remarks).openOn(map);
									}
								}
							});
						}else{
							var alertPopup = L.popup();
							alertPopup.setLatLng(map.getCenter()).setContent('layer not logged').openOn(map);
						}
					},
					error: function (response) {
						var alertPopup = L.popup();
						alertPopup.setLatLng(map.getCenter()).setContent(response).openOn(map);
					}
           		});
			}).on('pasteImageError', function(ev, data){
				alert('Oops: ' + data.message);
				if(data.url){
				  alert('But we got its url anyway:' + data.url)
				}
			}).on('pasteText', function(ev, data){
				$('#markerMessage').insertAfter(this);
			});
		});

		function toggleFullScreen() {
			if (!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement ) {  // current working methods
				if (document.documentElement.requestFullscreen) {
				  document.documentElement.requestFullscreen();
				} else if (document.documentElement.msRequestFullscreen) {
				  document.documentElement.msRequestFullscreen();
				} else if (document.documentElement.mozRequestFullScreen) {
				  document.documentElement.mozRequestFullScreen();
				} else if (document.documentElement.webkitRequestFullscreen) {
				  document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
				}
			} else {
				if (document.exitFullscreen) {
				  document.exitFullscreen();
				} else if (document.msExitFullscreen) {
				  document.msExitFullscreen();
				} else if (document.mozCancelFullScreen) {
				  document.mozCancelFullScreen();
				} else if (document.webkitExitFullscreen) {
				  document.webkitExitFullscreen();
				}
			}
		}
	</script>
	<div id="coord" style="width: 185px; display: none">
		<button id="btnInfoMarker" class="btn btn-info mt-1">
			<img src="/icon/019-pin-4.png" style="width: 32px; height: 32px" />
			<div>資訊</div>
		</button>
		<button id="btnRedInfoMarker" class="btn btn-info mt-1">
			<img src="/icon/017-pin-6.png" style="width: 32px; height: 32px" />
			<div>資訊</div>
		</button>
		<button id="btnYellowInfoMarker" class="btn btn-info mt-1">
			<img src="/icon/018-pin-5.png" style="width: 32px; height: 32px" />
			<div>資訊</div>
		</button>

		<button id="btnMedicalMarker" class="btn btn-light mt-1">
			<img src="/icon/010-first-aid-kit.png" style="width: 32px; height: 32px" />
			<div>救護</div>
		</button>
		<button id="btnGroupMarker" class="btn btn-info mt-1">
			<img src="/icon/group.png" style="width: 32px; height: 32px" />
			<div>人群</div>
		</button>
		<button id="btnSupplyMarker" class="btn btn-success mt-1">
			<img src="/icon/supply.png" style="width: 32px; height: 32px" />
			<div>補給</div>
		</button>

		<button id="btnWarningMarker" class="btn btn-warning mt-1">
			<img src="/icon/warning.png" style="width: 32px; height: 32px" />
			<div>警示</div>
		</button>
		<button id="btnBlockadeMarker" class="btn btn-danger mt-1">
			<img src="/icon/ironbarrier.png" style="width: 32px; height: 32px" />
			<div>封鎖</div>
		</button>
		<button id="btnPoliceMarker" class="btn btn-secondary mt-1">
			<img src="/icon/police.png" style="width: 32px; height: 32px" />
			<div>警察</div>
		</button>

		<button id="btnFBLiveStreamMarker" class="btn btn-secondary mt-1">
			<img src="/icon/live.png" style="width: 32px; height: 32px" />
			<div>FB</div>
		</button>
		
		<button id="btnTwitchLiveStreamMarker" class="btn btn-secondary mt-1">
			<img src="/icon/live.png" style="width: 32px; height: 32px" />
			<div>Twitch</div>
		</button>
				
		<button id="btnImageMarker" class="btn btn-secondary mt-1">
			<img src="/icon/image.png" style="width: 32px; height: 32px" />
			<div>Image</div>
		</button>
		<div style="display:none">
		 <input type="file" id="imageUploadFile" name="file" accept="image/*" capture>
		<input type="hidden" name="imagePath" id="imagePath"/></div>
		<textarea id="markerMessage" class="form-control mt-1" rows="2" placeholder="(Message ...or paste the image)" style="width: 100%"></textarea>
	</div>

	<div id="registerFormDiv" class="card shadow-sm m-2 p-4 rounded border border-info" style="display: none">
		<form method="post" id="registerForm" class="container">
			<div class="row form-group">
				<div class="col-4 btn">Layer :</div>
				<div class="col-8">
					<input class="form-control" type="text" placeholder="(layer)" name="layerKey" id="registerLayerKey"/>
				</div>
			</div>

			<div class="row form-group">
				<div class="col-4 btn">Password * :</div>
				<div class="col-8">
					<input class="form-control" type="password" placeholder="(password)" name="password" />
				</div>
			</div>

			<div class="row form-group">
				<div class="col-4 btn">Expire Multiplier :</div>
				<div class="col-8">
					<input class="form-control" type="text" placeholder="(default 10)" name="expireMultiplier" value="10"  style="color:#ACACAC"/>
				</div>
			</div>
			
			<div class="row m-1">
				<button class="col-8 btn btn-primary" type="submit">Create</button>
				<button class="col-4 btn btn-light" type="button" onclick="$('#registerFormDiv').hide()">Cancel</button>
			</div>

		</form>
	</div>
</html>